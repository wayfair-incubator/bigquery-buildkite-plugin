version: '3.5'

x-build-args: &build_args
  PLUGIN_VERSION: ${PLUGIN_VERSION}
  BUILD_DATE: ${BUILD_DATE:-BUILD_DATE_NOT_SET}

services:
  test:
    image: buildkite/plugin-tester
    volumes:
      - ".:/plugin"

  lint:
    image: buildkite/plugin-linter
    command: ['--id', 'wayfair-incubator/bigquery']
    volumes:
      - ".:/plugin"

  shfmt:
    build:
      context: .
      dockerfile: docker/shfmt.dockerfile
    command: "-s -l -w ." # (s)implify, (l)ist changes, (w)rite changes to file
    volumes:
      - ".:/plugin"

  bigquery-buildkite-plugin: &bigquery-buildkite-plugin
    build:
      dockerfile: docker/service.dockerfile
      context: .
      args: *build_args
    image: "wayfair-incubator/bigquery-buildkite-plugin"
    environment:
      - GCP_PROJECT='wf-gcp-us-ae-ops-dev'
      - BUILDKITE_BRANCH='asdad'
      - SCHEMA_DIRECTORY='junk/test'
    volumes:
      - "./:/app"

  devbox:
    <<: *bigquery-buildkite-plugin
    tty: true
    entrypoint: /bin/bash

  lock-requirements:
    <<: *bigquery-buildkite-plugin
    entrypoint: "/bin/bash"
    command: "docker/lock_requirements.sh"

volumes:
  home:
  env:
    driver: local
